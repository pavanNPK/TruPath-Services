<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Admin Register | TruPath Services</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../assets/images/core/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/images/core/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/images/core/favicon-16x16.png">
  <link rel="icon" type="image/svg+xml" href="../assets/images/core/favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/images/core/apple-touch-icon.png">

  <!-- CSS -->
  <link rel="stylesheet" href="../lib/css/bootstrap.min.css">
  <link rel="stylesheet" href="./admin.css">

  <style>
    .form-group {
      position: relative;
      margin-bottom: 5px; /* Increased margin to prevent overlap */
      min-height: 65px; /* Reserve space for error messages */
    }

    /* Make sure input field and icon share a stable line-height space */
    .form-group .form-control {
      padding-right: 40px;
      height: 48px;
      line-height: 48px;
      box-sizing: border-box;
      margin-bottom: 0; /* Remove default margin */
    }

    /* Stable toggle icon */
    .toggle-password {
      position: absolute;
      right: 15px;
      top: 14px; /* Fixed position relative to input field */
      cursor: pointer;
      color: #777;
      z-index: 2;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Error text with proper spacing */
    .error {
      position: absolute;
      bottom: 0;
      left: 0;
      font-size: 12px;
      color: #e63946;
      display: none;
      transition: opacity 0.2s ease;
      width: 100%;
      line-height: 1.2;
      margin: 0;
    }
    #passwordError {
        top: 50px !important;
    }

    /* Dynamic margin for confirm password field */
    .confirm-password-with-margin {
        margin-top: 20px;
    }

    /* Loading Spinner Styles */
    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid #4ecdc4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
    }

    .toast {
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left: 4px solid #4ecdc4;
    }

    .toast.error {
      border-left: 4px solid #ff6b6b;
    }

  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>
  <div class="left-panel">
    <img src="../assets/images/core/favicon.svg" alt="Logo" class="logo">
    <img src="../assets/images/admin/login.webp" alt="Login Illustration" class="illustration">
    <div class="bottom-text">
      <p>Welcome to TruPath Services ‚Äî Your career journey starts here.</p>
    </div>
  </div>

  <div class="right-panel">
    <!-- Register Form -->
    <div class="login-box" id="registerBox">
      <div class="brand-logo mb-3">
        <img src="../assets/images/admin/admin-login-form.svg" alt="TruPath Logo">
      </div>
      <h4>Register</h4>
      <form id="registerForm" novalidate>
        <div class="form-group">
          <input id="name" type="text" class="form-control" placeholder="Name" required>
          <small class="error" id="nameError">Name must be 3‚Äì15 letters only.</small>
        </div>

        <div class="form-group">
          <input id="email" type="email" class="form-control" placeholder="Email" required>
          <small class="error" id="emailError">Enter a valid email address.</small>
        </div>

        <div class="form-group">
          <input id="password" type="password" class="form-control" placeholder="Password" required>
          <span class="toggle-password" onclick="togglePassword('password', this)">üëÅ</span>
          <small class="error" id="passwordError">
            Must contain 1 uppercase & lowercase & number & special char, 8‚Äì16 characters.
          </small>
        </div>

        <div class="form-group" id="confirmPasswordGroup">
          <input id="confirmPassword" type="password" class="form-control" placeholder="Confirm Password" required>
          <span class="toggle-password" onclick="togglePassword('confirmPassword', this)">üëÅ</span>
          <small class="error" id="confirmError">Passwords do not match.</small>
        </div>

        <button type="submit" class="btn-login mt-2">Register</button>
        <div class="text-center mt-3">
          <p class="small m-0">Already have an account?
            <a href="./login.html" class="fw-bold text-black text-decoration-none">Login</a>
          </p>
        </div>
      </form>
    </div>

    <!-- OTP Verification -->
    <div class="login-box" id="otpBox" style="display: none;">
      <div class="brand-logo mb-3">
        <img src="../assets/images/admin/admin-login-form.svg" alt="TruPath Logo">
      </div>
      <p class="fw-bold fs-5 mb-1" id="greetUser">Hello</p>
      <p class="text-muted small mb-3">Kindly enter the OTP that has been sent to your email. <br> We have also sent an OTP to your admin email.</p>

      <form id="otpForm">
        <div class="form-group">
          <input id="otpInput" type="text" class="form-control mb-3" placeholder="Enter OTP" maxlength="6" required>
          <small class="error" id="otpError">OTP must be exactly 6 digits.</small>
        </div>
        <div class="form-group">
          <input id="adminOtpInput" type="text" class="form-control mb-3" placeholder="Enter Admin OTP" maxlength="6" required>
          <small class="error" id="adminOtpError">Admin OTP must be exactly 6 digits.</small>
        </div>
        <button type="submit" class="btn-login">Verify</button>
        <div class="text-center mt-3">
          <a href="#" id="resendOtp" class="text-decoration-none small text-dark">Resend OTP</a>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Base URL
    const API_BASE_URL = 'http://localhost:3000';
  
    // DOM elements
    const nameEl = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const confirmEl = document.getElementById('confirmPassword');
    const otpInput = document.getElementById('otpInput');
    const adminOtpInput = document.getElementById('adminOtpInput');
    const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
    const registerBox = document.getElementById('registerBox');
    const otpBox = document.getElementById('otpBox');
    const greetUser = document.getElementById('greetUser');
    const resendOtp = document.getElementById('resendOtp');
  
    // Error elements
    const nameError = document.getElementById('nameError');
    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    const confirmError = document.getElementById('confirmError');
    const otpError = document.getElementById('otpError');
    const adminOtpError = document.getElementById('adminOtpError');
  
    // Loader & Toast functions
    function showLoader(show) {
      const loader = document.getElementById('loadingSpinner');
      if (loader) loader.style.display = show ? 'block' : 'none';
    }
  
    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
  
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }
  
    function togglePassword(id, icon) {
      const input = document.getElementById(id);
      input.type = input.type === "password" ? "text" : "password";
      icon.textContent = input.type === "password" ? "üëÅ" : "üôà";
    }
  
    // Validation logic (unchanged)
    function validateName() {
      const valid = /^[A-Za-z ]{3,15}$/.test(nameEl.value.trim());
      nameError.style.display = valid ? 'none' : 'block';
      return valid;
    }
    function validateEmail() {
      const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value.trim());
      emailError.style.display = valid ? 'none' : 'block';
      return valid;
    }
    function validatePassword() {
      const valid = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,16}$/.test(passwordEl.value);
      passwordError.style.display = valid ? 'none' : 'block';
      if (valid) confirmPasswordGroup.classList.remove('confirm-password-with-margin');
      else confirmPasswordGroup.classList.add('confirm-password-with-margin');
      return valid;
    }
    function validateConfirmPassword() {
      const valid = passwordEl.value === confirmEl.value && confirmEl.value.length > 0;
      confirmError.style.display = valid ? 'none' : 'block';
      return valid;
    }
    function validateOtp() {
      const valid = /^\d{6}$/.test(otpInput.value.trim());
      otpError.style.display = valid ? 'none' : 'block';
      return valid;
    }
    function validateAdminOtp() {
      const valid = /^\d{6}$/.test(adminOtpInput.value.trim());
      adminOtpError.style.display = valid ? 'none' : 'block';
      return valid;
    }
  
    // Real-time validation
    nameEl.addEventListener('input', validateName);
    emailEl.addEventListener('input', validateEmail);
    passwordEl.addEventListener('input', validatePassword);
    confirmEl.addEventListener('input', validateConfirmPassword);
    otpInput.addEventListener('input', () => { otpInput.value = otpInput.value.replace(/\D/g, ''); validateOtp(); });
    adminOtpInput.addEventListener('input', () => { adminOtpInput.value = adminOtpInput.value.replace(/\D/g, ''); validateAdminOtp(); });
  
    // --- ‚úÖ REGISTER API (login-style) ---
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
  
      const valid =
        validateName() &&
        validateEmail() &&
        validatePassword() &&
        validateConfirmPassword();
  
      if (!valid) return;
  
      try {
        showLoader(true);
  
        const res = await fetch(`${API_BASE_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: nameEl.value.trim(),
            email: emailEl.value.trim(),
            password: passwordEl.value
          })
        });
  
        const data = await res.json();
  
        if (data.success) {
          window.currentUserId = data.userId;
          greetUser.textContent = `Hello ${nameEl.value}`;
          registerBox.style.display = 'none';
          otpBox.style.display = 'block';
          showToast('OTP sent to your email and admin email', 'success');
        } else {
          showToast(data.message || 'Registration failed', 'error');
        }
      } catch (err) {
        console.error('Registration error:', err);
        showToast('Network error. Please try again.', 'error');
      } finally {
        showLoader(false);
      }
    });
  
    // --- ‚úÖ OTP VERIFY API (login-style) ---
    document.getElementById('otpForm').addEventListener('submit', async (e) => {
      e.preventDefault();
  
      const otpValid = validateOtp();
      const adminOtpValid = validateAdminOtp();
  
      if (!otpValid || !adminOtpValid) return;
  
      try {
        showLoader(true);
  
        const res = await fetch(`${API_BASE_URL}/auth/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: window.currentUserId,
            userOtp: otpInput.value.trim(),
            adminOtp: adminOtpInput.value.trim()
          })
        });
  
        const data = await res.json();
  
        if (data.success) {
          showToast('Registration successful! Redirecting...', 'success');
          setTimeout(() => window.location.href = './login.html', 1500);
        } else {
          showToast(data.message || 'OTP verification failed', 'error');
        }
      } catch (err) {
        console.error('OTP verification error:', err);
        showToast('Network error. Please try again.', 'error');
      } finally {
        showLoader(false);
      }
    });
  
    // --- ‚úÖ RESEND OTP (login-style) ---
    resendOtp.addEventListener('click', async (e) => {
      e.preventDefault();
  
      if (!window.currentUserId) {
        showToast('Session expired. Please register again.', 'error');
        return;
      }
  
      try {
        showLoader(true);
  
        const res = await fetch(`${API_BASE_URL}/auth/resend-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: window.currentUserId })
        });
  
        const data = await res.json();
  
        if (data.success) {
          showToast('OTPs resent successfully to both emails.', 'success');
        } else {
          showToast(data.message || 'Failed to resend OTP.', 'error');
        }
      } catch (err) {
        console.error('Resend OTP error:', err);
        showToast('Network error. Please try again.', 'error');
      } finally {
        showLoader(false);
      }
    });
  </script>  
</body>
</html>
